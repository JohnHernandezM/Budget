Option Explicit

'==== Configuration ====
Private Const WATCH_ADDR      As String = "C2"
Private Const OUTPUT_ADDR     As String = "C6"
Private Const BANK_TABLE      As String = "Data_Bank_Logo"
Private Const KEY_COL_INDEX   As Long = 1
Private Const COLOR_COL_INDEX As Long = 3
'=======================

' - Main Sheet.
' - Watches C2 and colors C6 based on a key lookup against table Data_Bank_Logo.
Private Sub Worksheet_Change(ByVal Target As Range)
    On Error GoTo CleanUp

    ' Only react when C2 is edited (even if part of a multi-cell paste).
    If Intersect(Target, Me.Range(WATCH_ADDR)) Is Nothing Then Exit Sub

    Dim prevEvents As Boolean
    prevEvents = Application.EnableEvents
    Application.EnableEvents = False

    Dim key As String
    key = Trim$(CStr(Me.Range(WATCH_ADDR).Value))

    ' If empty, just clear fill and exit.
    If Len(key) = 0 Then
        Me.Range(OUTPUT_ADDR).Interior.ColorIndex = xlColorIndexNone
        GoTo CleanUp
    End If

    Dim tbl As ListObject
    Set tbl = FindBankTable(BANK_TABLE)

    ' If the table cannot be found, clear fill and exit gracefully.
    If tbl Is Nothing Then
        Me.Range(OUTPUT_ADDR).Interior.ColorIndex = xlColorIndexNone
        GoTo CleanUp
    End If

    ' If no data rows, clear fill.
    If tbl.ListRows.Count = 0 Then
        Me.Range(OUTPUT_ADDR).Interior.ColorIndex = xlColorIndexNone
        GoTo CleanUp
    End If

    Dim firstCol As Range
    Set firstCol = tbl.ListColumns(KEY_COL_INDEX).DataBodyRange

    Dim hit As Range
    Set hit = firstCol.Find(What:=key, LookIn:=xlValues, LookAt:=xlWhole, _
                            SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False)

    With Me.Range(OUTPUT_ADDR).Interior
        If Not hit Is Nothing Then
            ' COLOR_COL_INDEX is relative to the table's first column.
            .Color = hit.Offset(0, COLOR_COL_INDEX - KEY_COL_INDEX).Interior.Color
        Else
            .ColorIndex = xlColorIndexNone
        End If
    End With

CleanUp:
    Application.EnableEvents = prevEvents
End Sub

' Helper: Locate the table by name, scanning the workbook.
' Returns Nothing if not found.
Private Function FindBankTable(ByVal tableName As String) As ListObject
    Dim ws As Worksheet
    Dim lo As ListObject

    For Each ws In ThisWorkbook.Worksheets
        On Error Resume Next
        Set lo = Nothing
        Set lo = ws.ListObjects(tableName)
        On Error GoTo 0
        If Not lo Is Nothing Then
            Set FindBankTable = lo
            Exit Function
        End If
    Next ws

    ' Optional fallback: try workbook Name "Data_Bank_Logo[#All]" if it exists.
    On Error Resume Next
    Dim nm As Name
    Set nm = ThisWorkbook.Names(tableName & "[#All]")
    If Not nm Is Nothing Then
        If Not nm.RefersToRange Is Nothing Then
            If Not nm.RefersToRange.ListObject Is Nothing Then
                Set FindBankTable = nm.RefersToRange.ListObject
            End If
        End If
    End If
    On Error GoTo 0
End Function
